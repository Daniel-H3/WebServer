<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CBSL - Home</title>
<style>
  @font-face {
    font-family: 'Orbitron';
    src: url('Orbitron-Regular.woff2') format('woff2'),
        url('Orbitron-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  body {
    margin: 0;
    background: #0a0f1a;
    font-family: 'Orbitron', sans-serif;
    color: #a0cfff;
    overflow-x: hidden;
  }

  .container {
    width: auto;
    margin: 15px;
    padding: 20px;
    background: rgba(10, 15, 26, 0.8);
    border: 2px solid #1a9cff;
    border-radius: 12px;
    box-shadow: 0 0 20px #1a9cff;
  }

  @media (max-width: 600px) {
    .container {
      max-width: 100%;
      margin: 20px 10px;
      padding: 10px;
      border-width: 1px;
      box-shadow: none;
      border-radius: 8px;
    }

    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    nav a {
      margin-left: 0;
      margin-right: 15px;
      font-size: 0.9rem;
    }

    .dashboard-grid {
      gap: 15px;
    }

    .scale-controls {
      flex-direction: column;
      gap: 8px;
    }

    .scale-controls input,
    .scale-controls select {
      width: 100%;
      max-width: none;
    }

    .data-cards {
      flex-direction: column;
      gap: 15px;
    }

    .data-card {
      flex: 1 1 100%;
      max-width: 100%;
    }

    .control-buttons {
      flex-direction: column;
      gap: 15px;
    }

    .control-btn {
      width: 100%;
      padding: 12px 0;
      font-size: 1rem;
    }
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #1a9cff;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }

  header h1 {
    font-size: 1.8rem;
    color: #1a9cff;
    letter-spacing: 2px;
  }

  nav a {
    color: #a0cfff;
    text-decoration: none;
    margin-left: 20px;
    font-weight: 600;
    font-size: 1rem;
    transition: color 0.3s ease;
  }

  nav a:hover {
    color: #1a9cff;
  }

  .dashboard-grid {
    display: grid;
    grid-template-rows: auto auto auto;
  }

  .graph-container {
    width: 100%;
    height: auto; 
    overflow-x: hidden;
  }

  details {
    background: rgba(26, 156, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 0 10px #1a9cff88 inset;
  }

  summary {
    font-weight: 600;
    cursor: default;
    color: #1a9cff;
    font-size: 1.2rem;
    user-select: none;
  }

  .scale-controls {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
    text-align: center;
  }

  .scale-controls label {
    font-size: 0.9rem;
  }

  .scale-controls input,
  .scale-controls select {
    width: 90px;
    padding: 4px 6px;
    border-radius: 4px;
    border: 1px solid #1a9cff;
    background: #0a0f1a;
    color: #a0cfff;
    font-family: 'Orbitron', sans-serif;
  }

  .timestamp-container {
    background: rgba(26, 156, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 0 10px #1a9cff88 inset;
    margin-bottom: 20px;
  }

  .timestamp-container h3 {
    margin-top: 0;
    margin-bottom: 10px;
  }

  .timestamp-list {
    list-style: none;
    padding-left: 0;
    max-height: 150px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
  }

  .data-cards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-items: center;
    align-items: flex-start;
    justify-content: space-between;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .graph-container {
    width: 100%;
  }
  .graph-container h3 {
    margin-bottom: 10px;
    font-size: 1.2rem;
    color: #1a9cff;
  }

  .data-card {
    font-size: 12px;
    height: 100%;
    background: rgba(26, 156, 255, 0.1);
    border-radius: 8px;
    padding: 5px;
    width: 100%;
    box-shadow: 0 0 10px #1a9cff88 inset;
    text-align: center;
    box-sizing: border-box;
  }
  .data-cards:has(.data-card:nth-child(1):last-child) .data-card {
    flex: 0 0 100%;
  }

  .data-card:nth-child(3):last-child {
    flex: 0 0 100%;
  }

  .data-card h4 {
    margin: 10px 0 10px 0;
  }

  .gauge {
    margin-bottom: 10px;
  }

  .circular-chart {
    max-width: 100px;
    max-height: 100px;
    margin: 0 auto;
    display: block;
  }

  .circle-bg {
    fill: none;
    stroke: #eee;
    stroke-width: 3.8;
  }

  .circle {
    fill: none;
    stroke-width: 2.8;
    stroke-linecap: round;
    transition: stroke-dasharray 0.3s ease;
  }

  .yellow .circle {
    stroke: #f1c40f;
  }

  .percentage {
    fill: #fff;
    font-size: 0.5em;
    text-anchor: middle;
  }

  .current-value {
    font-weight: 700;
  }

  .control-buttons {
    grid-column: 1 / 3;
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .control-btn {
    background-color: #1a9cff;
    border: none;
    border-radius: 8px;
    color: #0a0f1a;
    font-weight: 700;
    font-size: 1.2rem;
    padding: 12px 30px;
    cursor: pointer;
    box-shadow: 0 0 15px #1a9cff;
    transition: background-color 0.3s ease;
  }

  .control-btn:hover {
    background-color: #0d7adf;
  }

  /* Background grid effect */
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at center, #1a9cff22 1px, transparent 1px),
                radial-gradient(circle at center, #1a9cff22 1px, transparent 1px);
    background-position: 0 0, 25px 25px;
    background-size: 50px 50px;
    pointer-events: none;
    z-index: 0;
  }

  /* Prevent horizontal scroll */
  body {
    overflow-x: hidden;
  }

  @media (max-width: 900px) {
    .data-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .data-cards {
      grid-template-columns: 1fr;
    }
  }
  .param-block {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 30px;
    background: rgba(26, 156, 255, 0.05);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 0 10px #1a9cff55;
  }

  .param-block .graph-container {
    flex: 2 1 60%;
    min-width: 250px;
  }

  .param-block .data-card {
    flex: 1 1 30%;
    min-width: 200px;
    max-width: 300px;
    align-self: center
  }

  .param-block .scale-controls {
    flex: 1 1 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  #horizontalTimestampTable th, #horizontalTimestampTable td {
    border: 1px solid #1a9cff;
    padding: 4px;
    text-align: center;
  }
  #horizontalTimestampTable th {
    background-color: rgba(26, 156, 255, 0.2);
  }
  #timestampTables > div {
    box-shadow: 0 0 10px #1a9cff44 inset;
    background: rgba(26, 156, 255, 0.05);
  }
</style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>Computer Based Science Learning</h1>
      <nav>
        <a href="index.html" class="active">Home</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main>
      <section aria-label="Dashboard">
        <div class="dashboard-grid">
          
          <div id="multiGraphContainer"></div>
          <div class="control-buttons">
            <button id="exportBtn" class="control-btn">EXPORT</button>
            <button id="stopBtn" class="control-btn">STOP</button>
            <button id="runBtn" class="control-btn">RUN</button>
          </div>
          <div class="timestamp-container" style="margin-top: 20px;">
              <h3>TIMESTAMP</h3>
              <div id="timestampTables" 
                style="display: flex; 
                flex-direction: row; 
                gap: 20px;  
                justify-content: space-around;">
                <!-- Diisi tabel per parameter lewat JavaScript -->
              </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      &copy; 2024 Computer Based Science Learning (Pembelajaran Sains Berbasis Komputer)
    </footer>
  </div>
  <script src="/chart.js"></script>
  <script src="/chartjs-plugin-zoom.min.js"></script>
  <script src="/jspdf.umd.min.js"></script>
  <script>
    let logIntervalsByParam = {};
    // Map parameter to color for chart lines
    const parameterColors = {
      'Arus AC/DC': '#1a9cff',
      'Bunyi': '#ff6666',
      'Cahaya': '#33cc33',
      'Gaya': '#ff9933',
      'Jarak': '#cc33ff',
      'Tegangan AC': '#ff33cc',
      'Tegangan DC': '#3399ff',
      'Temperatur': '#ffcc33'
    };
    
    const parameterInfo = {
      "Arus AC/DC": { unit: "A", full: "Ampere" },
      "Bunyi": { unit: "dB", full: "Desibel" },
      "Cahaya": { unit: "lux", full: "Lux" },
      "Gaya": { unit: "N", full: "Newton" },
      "Jarak": { unit: "cm", full: "Centimeter" },
      "Tegangan AC": { unit: "V", full: "Volt" },
      "Tegangan DC": { unit: "V", full: "Volt" },
      "Temperatur": { unit: "°C", full: "Derajat Celcius" }
    };

    // variabel buat nambah grafik
    const chartsByParam = {};
    const datasetsByParam = {};

    function createIndividualParamBlocks() {
      const enabledParams = getEnabledParameters();
      const container = document.getElementById("multiGraphContainer");
      container.innerHTML = '';

      enabledParams.forEach(param => {
        const id = param.replace(/[^\w]/g, '');
        const color = parameterColors[param] || '#1a9cff';
        const unit = parameterInfo[param]?.unit || '';
        const full = parameterInfo[param]?.full || '';

        // ==== BUAT ELEMEN ====
        const block = document.createElement("div");
        block.className = "param-block";

        const canvas = document.createElement("canvas");
        canvas.id = `chart-${id}`;
        canvas.style.maxHeight = "300px";

        const title = document.createElement("h3");
        title.textContent = `Grafik ${param}`;
        title.style.margin = "0 0 10px 0";
        title.style.color = color;
        title.style.fontSize = "1.2rem";
        
        const chartContainer = document.createElement("div");
        chartContainer.appendChild(title);  
        chartContainer.className = "graph-container";
        chartContainer.appendChild(canvas);

        const dataCard = document.createElement("div");
        dataCard.className = "data-card";
        dataCard.id = `card-${id}`;
        dataCard.innerHTML = `
          <h4>${param}</h4>
          <div class="gauge">
            <svg viewBox="0 0 36 36" class="circular-chart yellow">
              <path class="circle-bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <path class="circle"
                stroke-dasharray="0, 100"
                stroke="${color}"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"/>
              <text x="18" y="20.35" class="percentage">0</text>
            </svg>
          </div>
          <p class="current-value" id="value-${id}">Current: --</p>
          <p id="max-${id}" class="max-value">Max: --</p>
          <p id="min-${id}" class="min-value">Min: --</p>
        `;

        const controls = document.createElement("div");
        controls.className = "scale-controls";
        controls.innerHTML = `
          <label>X Min:<input type="number" id="xMin-${id}" value="0" step="1"/></label>
          <label>X Max:<input type="number" id="xMax-${id}" value="10" step="1"/></label>
          <label>X Unit:
            <select id="xUnit-${id}">
              <option value="ms">ms</option>
              <option value="s" selected>second</option>
              <option value="min">minutes</option>
            </select>
          </label>
          <label>Y Min:<input type="number" id="yMin-${id}" value="0" step="1"/></label>
          <label>Y Max:<input type="number" id="yMax-${id}" value="100" step="1"/></label>
        `;

        // ==== SUSUN BLOK ====
        block.appendChild(chartContainer);
        block.appendChild(dataCard);
        block.appendChild(controls);
        container.appendChild(block);

        // ==== INISIALISASI CHART ====
        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: param,
              data: [],
              borderColor: color,
              backgroundColor: 'transparent',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            animation: false,
            plugins: {legend: false},
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
                modifierKey: null,
                threshold: 5,
              },
              zoom: {
                enabled: false
              }
            },
            scales: {
              x: { type: 'linear', min: 0, max: 10, title: { display: true, text: `Time (${xUnit})` } },
              y: { beginAtZero: false, min: 0, max: 100, title: { display: true, text: `${param} (${full} (${unit}))` } }
            }
          }
        });

        chartsByParam[param] = chart;
        datasetsByParam[param] = chart.data.datasets[0];

        // ==== EVENT HANDLER UNTUK PENGATURAN ====
        function updateScale() {
          const xMin = parseFloat(document.getElementById(`xMin-${id}`).value);
          const xMax = parseFloat(document.getElementById(`xMax-${id}`).value);
          const yMin = parseFloat(document.getElementById(`yMin-${id}`).value);
          const yMax = parseFloat(document.getElementById(`yMax-${id}`).value);
          const xUnitSelect = document.getElementById(`xUnit-${id}`);
          const unitVal = xUnitSelect.value;

          chart.options.scales.x.min = xMin;
          chart.options.scales.x.max = xMax;
          chart.options.scales.y.min = yMin;
          chart.options.scales.y.max = yMax;
          chart.options.scales.x.title.text = `Time (${unitVal})`;
          

          chart.options.scales.x.ticks.callback = function (value) {
            return unitVal === 'ms' ? `${value} ms` :
                  unitVal === 's' ? `${value} s` :
                  `${value} min`;
          };

          chart.update();
        }

        controls.querySelectorAll("input, select").forEach(el => {
          el.addEventListener("change", updateScale);
        });
      });
    }
    // Register zoom plugin with Chart.js
    Chart.register(ChartZoom);

    // Logging state
    let logging = false;
    let logIntervalId = null;
    let logIntervalMs = 2000;
    let timeIndexByParam = {};
    // variabel tabel timestamp
    let timestampMatrix = {}; // Menyimpan data per parameter
    let timestampRowCount = 0;
    let xUnit = 's'; // default seconds
    let yUnit = 'Volt'; // default Volt

    // Timestamp list element
    //const timestampList = document.getElementById('timestampList');

    // Data cards container
    const dataCardsContainer = document.getElementById('dataCardsContainer');

    // Load enabled parameters and units from localStorage
    function getEnabledParameters() {
      const settings = JSON.parse(localStorage.getItem('thunderflowSettings')) || {};
      const enabledParams = [];
      if (settings.arus) enabledParams.push('Arus AC/DC');
      if (settings.bunyi) enabledParams.push('Bunyi');
      if (settings.cahaya) enabledParams.push('Cahaya');
      if (settings.gaya) enabledParams.push('Gaya');
      if (settings.jarak) enabledParams.push('Jarak');
      if (settings.teganganAC) enabledParams.push('Tegangan AC');
      if (settings.teganganDC) enabledParams.push('Tegangan DC');
      if (settings.temperatur) enabledParams.push('Temperatur');
      //if (settings.interval) logIntervalMs = parseInt(settings.interval) || 2000;
      logIntervalsByParam = {
        "Arus AC/DC": parseInt(settings["interval-arus"]) || 2000,
        "Bunyi": parseInt(settings["interval-bunyi"]) || 2000,
        "Cahaya": parseInt(settings["interval-cahaya"]) || 2000,
        "Gaya": parseInt(settings["interval-gaya"]) || 2000,
        "Jarak": parseInt(settings["interval-jarak"]) || 2000,
        "Tegangan AC": parseInt(settings["interval-teganganAC"]) || 2000,
        "Tegangan DC": parseInt(settings["interval-teganganDC"]) || 2000,
        "Temperatur": parseInt(settings["interval-temperatur"]) || 2000
      };
      if (settings.xUnit) xUnit = settings.xUnit;
      if (settings.yUnit) yUnit = settings.yUnit;
      return enabledParams;
    }

    // Update circular gauge stroke-dasharray and percentage text
    function updateGauge(param, value, min, max, unit) {
      const id = param.replace(/[^\w]/g, '');
      const card = document.getElementById(`card-${id}`);
      if (!card) return;

      const circle = card.querySelector('.circle');
      const percentageText = card.querySelector('.percentage');
      const valueElem = document.getElementById(`value-${id}`);
      const minElem = document.getElementById(`min-${id}`);
      const maxElem = document.getElementById(`max-${id}`);

      if (!circle || !percentageText) return;

      const maxDashArray = 100;
      const dashArrayValue = (value / 100) * maxDashArray;
      circle.setAttribute('stroke-dasharray', `${dashArrayValue}, ${maxDashArray}`);
      percentageText.textContent = `${value.toFixed(1)}%`;

      if (valueElem) valueElem.innerHTML = `Current: ${value.toFixed(2)} ${unit}`;
      if (minElem) minElem.textContent = `Min: ${min.toFixed(2)} ${unit}`;
      if (maxElem) maxElem.textContent = `Max: ${max.toFixed(2)} ${unit}`;
    }

    // Convert time index to x value based on selected unit
    function convertTimeIndexToXValue(timeIndex) {
      if (xUnit === 'ms') {
        return timeIndex * logIntervalMs;
      } else if (xUnit === 's') {
        return (timeIndex * logIntervalMs) / 1000;
      } else if (xUnit === 'min') {
        return (timeIndex * logIntervalMs) / 60000;
      }
      return timeIndex;
    }

    // Simulate logging data
    let parameterStats = {};

    function logDataPoint(param) {
      const id = param.replace(/[^\w]/g, '');
      const intervalMs = logIntervalsByParam[param] || 2000;
      const timeIndex = timeIndexByParam[param];

      const xUnitSelect = document.getElementById(`xUnit-${id}`);
      const unitVal = xUnitSelect?.value || 's';

      let xVal;
      if (unitVal === 'ms') xVal = timeIndex * intervalMs;
      else if (unitVal === 's') xVal = (timeIndex * intervalMs) / 1000;
      else xVal = (timeIndex * intervalMs) / 60000;

      const now = new Date();
      const timeLabel = now.toISOString().slice(11, 23);// "HH:mm:ss.SSS"
      //const timeLabel = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');
      

      fetch('/data')
        .then(response => response.json())
        .then(sensorData => {
          const dataset = datasetsByParam[param];
          const sensorValue = parseFloat(sensorData[param]) || 0;

          if (!parameterStats[param]) {
            parameterStats[param] = { min: sensorValue, max: sensorValue };
          } else {
            parameterStats[param].min = Math.min(parameterStats[param].min, sensorValue);
            parameterStats[param].max = Math.max(parameterStats[param].max, sensorValue);
          }

          const min = parameterStats[param].min;
          const max = parameterStats[param].max;
          const unit = parameterInfo[param]?.unit || '';

          dataset.data.push({ x: xVal, y: sensorValue });
          chartsByParam[param]?.update();

          const valueElem = document.getElementById(`value-${id}`);
          const minElem = document.getElementById(`min-${id}`);
          const maxElem = document.getElementById(`max-${id}`);
          if (valueElem) valueElem.innerHTML = `Current: ${sensorValue.toFixed(2)} ${unit}`;
          if (minElem) minElem.textContent = `Min: ${min.toFixed(2)} ${unit}`;
          if (maxElem) maxElem.textContent = `Max: ${max.toFixed(2)} ${unit}`;

          if (!timestampMatrix[param]) {
            timestampMatrix[param] = [];

            const container = document.getElementById('timestampTables');

            // Buat wrapper div per parameter
            const wrapper = document.createElement('div');
            wrapper.id = `wrapper-${id}`;
            wrapper.style.maxHeight = '360px';
            wrapper.style.overflowY = 'auto';
            wrapper.style.border = '1px solid #1a9cff';
            wrapper.style.borderRadius = '8px';
            wrapper.style.padding = '10px';
            wrapper.style.width = '100%';

            // Judul parameter
            const title = document.createElement('h4');
            title.textContent = param;
            title.style.color = parameterColors[param] || '#fff';
            wrapper.appendChild(title);

            // Buat tabel
            const table = document.createElement('table');
            table.id = `table-${id}`;
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '0.9rem';
            table.innerHTML = `
              <thead>
                <tr>
                  <th style="padding:4px; text-align:left;">Waktu</th>
                  <th style="padding:4px; text-align:left;">Data</th>
                </tr>
              </thead>
              <tbody></tbody>
            `;

            wrapper.appendChild(table);
            container.appendChild(wrapper);
          }

          timestampMatrix[param].push({ time: timeLabel, value: sensorValue.toFixed(2) });
          let tbody = document.querySelector(`#table-${id} tbody`);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding:4px;">${timeLabel}</td>
            <td style="padding:4px;">${sensorValue.toFixed(2)} ${unit}</td>
          `;
          tbody.appendChild(row);

          // Perbarui panjang maksimum
          const maxRows = Math.max(...Object.values(timestampMatrix).map(arr => arr.length));
          timestampRowCount = maxRows;

          // // Kosongkan tbody
          // tbody = document.getElementById("timestampBody");
          // tbody.innerHTML = "";

          // // Render ulang seluruh isi tabel berdasarkan timestampMatrix
          // for (let i = 0; i < maxRows; i++) {
          //   const row = tbody.insertRow();
          //   for (const p of Object.keys(timestampMatrix)) {
          //     const entry = timestampMatrix[p][i];
          //     const cellTime = row.insertCell();
          //     const cellVal = row.insertCell();
          //     if (entry) {
          //       cellTime.textContent = entry.time;
          //       cellVal.textContent = entry.value;
          //     } else {
          //       cellTime.textContent = "-";
          //       cellVal.textContent = "-";
          //     }
          //   }
          // }

          updateGauge(param, sensorValue, min, max, unit);
        })
        .catch(error => {
          console.error(`Error fetching data for ${param}:`, error);
        });
    }
    function startLogging() {
      parameterStats = {};
      if (logging) {
        alert('Logging is already running.');
        return;
      }

      logging = true;
      logIntervalIdsByParam = {};
      timestampMatrix = {};
      timestampRowCount = 0;
      document.getElementById("timestampTables").innerHTML = "";


      // Reset semua grafik
      Object.values(chartsByParam).forEach(chart => {
        if (!chart) return;
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
      });

      // Set interval untuk tiap parameter
      Object.keys(datasetsByParam).forEach(param => {
        const id = param.replace(/[^\w]/g, '');
        const intervalMs = logIntervalsByParam[param] || 2000;
        timeIndexByParam[param] = 0; // MULAI dari 0 saat tombol START

        logDataPoint(param);  // titik pertama di x = 0
        const intervalId = setInterval(() => {
          timeIndexByParam[param]++;
          logDataPoint(param);        
        }, intervalMs);

        logIntervalIdsByParam[param] = intervalId;
      });
    }

   // Stop logging
    function stopLogging() {
      if (!logging) {
        alert('Logging is not running.');
        return;
      }
      logging = false;
      
      // Hentikan semua interval
      Object.values(logIntervalIdsByParam).forEach(clearInterval);
      logIntervalIdsByParam = {};
    }

    // Export chart and timestamp list to PDF
    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      const title = "THUNDERFLOW Data Export";
      const username = prompt("Masukkan Nama Anda:", "Nama Pengguna");
      const date = new Date().toLocaleString();

      pdf.setFontSize(18);
      pdf.text(title, 10, 15);
      pdf.setFontSize(12);
      pdf.text(`Nama: ${username}`, 10, 25);
      pdf.text(`Tanggal: ${date}`, 10, 32);

      let y = 40;

      // ===== GRAFIK PER PARAMETER =====
      for (const param in chartsByParam) {
        const canvas = document.getElementById(`chart-${param.replace(/[^\w]/g, '')}`);
        if (!canvas) continue;

        const imgData = canvas.toDataURL('image/png', 1.0);

        // Tambah halaman jika tinggi penuh
        if (y > 220) {
          pdf.addPage();
          y = 20;
        }

        pdf.setFontSize(14);
        pdf.text(`Grafik ${param}`, 10, y);
        y += 5;
        pdf.addImage(imgData, 'PNG', 10, y, 180, 60);
        y += 70;
      }

      // ===== TIMESTAMP LOG TABEL =====
      if (y > 200) {
        pdf.addPage();
        y = 20;
      }

      pdf.setFontSize(14);
      pdf.text('Log Timestamp:', 10, y);
      y += 10;

      pdf.setFontSize(10);
      // ===== TIMESTAMP FORMAT TABEL HORIZONTAL =====
      const activeParams = Object.keys(timestampMatrix);
      const rowCount = Math.max(...activeParams.map(p => timestampMatrix[p].length));

      if (y > 250) {
        pdf.addPage();
        y = 20;
      }

      pdf.setFontSize(14);
      pdf.text("Log Timestamp (Per Parameter - Horizontal)", 10, y);
      y += 10;

      // Header Parameter
      pdf.setFontSize(10);
      pdf.setFont(undefined, "bold");

      let x = 10;
      for (const param of activeParams) {
        pdf.text(param, x, y);
        x += 60;
      }
      y += 5;

      // Subheader "Waktu | Data"
      x = 10;
      for (const _ of activeParams) {
        pdf.text("Waktu", x, y);
        pdf.text("Data", x + 30, y);
        x += 60;
      }
      y += 5;

      pdf.setFont(undefined, "normal");

      // Isi Baris
      for (let i = 0; i < rowCount; i++) {
        x = 10;
        for (const param of activeParams) {
          const entry = timestampMatrix[param][i];
          if (entry) {
            pdf.text(entry.time, x, y);
            pdf.text(entry.value, x + 30, y);
          } else {
            pdf.text("-", x, y);
            pdf.text("-", x + 30, y);
          }
          x += 60;
        }
        y += 5;
        if (y > 280) {
          pdf.addPage();
          y = 20;
        }
      }

      pdf.save('Praktikum_Test.pdf');
    }

    // Initialize everything on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      createIndividualParamBlocks();
      document.getElementById('runBtn').addEventListener('click', () => {
        startLogging();
      });

      document.getElementById('stopBtn').addEventListener('click', () => {
        stopLogging();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        exportToPDF();
      });
    });
  </script>
</body>
</html>
